# AionUi é¡¹ç›®æ¶æ„æ·±åº¦åˆ†ææ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **é¡¹ç›®ç‰ˆæœ¬**: 1.7.2  
> **ç”Ÿæˆæ—¥æœŸ**: 2026-01-27  
> **æ–‡æ¡£ç±»å‹**: æŠ€æœ¯æ¶æ„åˆ†æ

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è§ˆ](#1-é¡¹ç›®æ¦‚è§ˆ)
2. [æ ¸å¿ƒæŠ€æœ¯æ ˆ](#2-æ ¸å¿ƒæŠ€æœ¯æ ˆ)
3. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#3-ç³»ç»Ÿæ¶æ„è®¾è®¡)
4. [ç›®å½•ç»“æ„è¯¦è§£](#4-ç›®å½•ç»“æ„è¯¦è§£)
5. [æ ¸å¿ƒåŠŸèƒ½ä¸å·¥ä½œæµç¨‹](#5-æ ¸å¿ƒåŠŸèƒ½ä¸å·¥ä½œæµç¨‹)
6. [å…³é”®è®¾è®¡æ¨¡å¼](#6-å…³é”®è®¾è®¡æ¨¡å¼)
7. [æ•°æ®å­˜å‚¨æ¶æ„](#7-æ•°æ®å­˜å‚¨æ¶æ„)
8. [æ‰©å±•å¼€å‘æŒ‡å—](#8-æ‰©å±•å¼€å‘æŒ‡å—)
9. [éƒ¨ç½²ä¸æ„å»º](#9-éƒ¨ç½²ä¸æ„å»º)
10. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#10-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)

---

## 1. é¡¹ç›®æ¦‚è§ˆ

### 1.1 é¡¹ç›®å®šä½

**AionUi** æ˜¯ä¸€ä¸ªåŸºäº Electron çš„è·¨å¹³å°æ¡Œé¢åº”ç”¨ï¼Œæ—¨åœ¨ä¸ºå‘½ä»¤è¡Œ AI ä»£ç†æä¾›ç°ä»£åŒ–çš„å›¾å½¢ç•Œé¢ã€‚å®ƒä¸ä»…ä»…æ˜¯ç®€å•çš„ Shell åŒ…è£…å™¨ï¼Œè€Œæ˜¯é€šè¿‡æ·±åº¦é›†æˆå®ç°äº†ï¼š

- ğŸ¤– **å¤š AI ä»£ç†ç»Ÿä¸€ç®¡ç†** - æ”¯æŒ Gemini CLIã€Claude Codeã€Codexã€Qwen Code ç­‰
- ğŸ“ **æ™ºèƒ½æ–‡ä»¶ç®¡ç†** - æ‰¹é‡é‡å‘½åã€è‡ªåŠ¨åˆ†ç±»ã€æ–‡ä»¶åˆå¹¶
- ğŸ“„ **å¤šæ ¼å¼é¢„è§ˆ** - æ”¯æŒ PDFã€Wordã€Excelã€PPTã€ä»£ç ã€Markdown ç­‰ 9+ æ ¼å¼
- ğŸ¨ **AI å›¾åƒç”Ÿæˆ** - é›†æˆ Gemini å›¾åƒç”Ÿæˆèƒ½åŠ›
- ğŸŒ **WebUI è¿œç¨‹è®¿é—®** - æ”¯æŒæµè§ˆå™¨è®¿é—®ï¼Œè·¨è®¾å¤‡ä½¿ç”¨
- ğŸ”§ **æŠ€èƒ½æ‰©å±•ç³»ç»Ÿ** - åŸºäºæ–‡ä»¶çš„æ’ä»¶åŒ–èƒ½åŠ›æ‰©å±•

### 1.2 æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§           | è¯´æ˜                                    | æŠ€æœ¯å®ç°                    |
| -------------- | --------------------------------------- | --------------------------- |
| **å¤šä¼šè¯ç®¡ç†** | æ”¯æŒå¤šä¸ªç‹¬ç«‹å¯¹è¯ï¼Œäº’ä¸å¹²æ‰°              | SQLite + æ–‡ä»¶å­˜å‚¨           |
| **æµå¼å“åº”**   | å®æ—¶æ˜¾ç¤º AI ç”Ÿæˆå†…å®¹                    | IPC Bridge + EventEmitter   |
| **å·¥å…·è°ƒç”¨**   | AI å¯æ‰§è¡Œæ–‡ä»¶æ“ä½œã€Shell å‘½ä»¤           | Worker Process éš”ç¦»æ‰§è¡Œ     |
| **æŠ€èƒ½ç³»ç»Ÿ**   | å¯æ‰©å±•çš„ Python/JS è„šæœ¬èƒ½åŠ›             | åŠ¨æ€åŠ è½½ + Frontmatter è§£æ |
| **MCP åè®®**   | æ”¯æŒ Model Context Protocol             | stdio/SSE/HTTP ä¼ è¾“         |
| **é¢„è®¾åŠ©æ‰‹**   | å†…ç½®å¤šä¸ªä¸“ä¸šåŠ©æ‰‹ï¼ˆPPT ç”Ÿæˆã€UI è®¾è®¡ç­‰ï¼‰ | é…ç½®åŒ–é¢„è®¾ç³»ç»Ÿ              |

---

## 2. æ ¸å¿ƒæŠ€æœ¯æ ˆ

### 2.1 å‰ç«¯æŠ€æœ¯

```
React 19.1.0          - UI æ¡†æ¶
Arco Design 2.66.1    - ä¼ä¸šçº§ UI ç»„ä»¶åº“
UnoCSS 66.3.3         - åŸå­åŒ– CSS å¼•æ“
Monaco Editor 4.7.0   - ä»£ç ç¼–è¾‘å™¨ï¼ˆVS Code å†…æ ¸ï¼‰
React Router 7.8.0    - è·¯ç”±ç®¡ç†
i18next 23.7.16       - å›½é™…åŒ–æ”¯æŒ
```

**ç‰¹è‰²åº“**:

- `react-markdown` - Markdown æ¸²æŸ“ï¼ˆæ”¯æŒ GFMã€æ•°å­¦å…¬å¼ï¼‰
- `diff2html` - ä»£ç å·®å¼‚å¯è§†åŒ–
- `react-virtuoso` - è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–é•¿åˆ—è¡¨
- `@floating-ui/react` - æµ®åŠ¨å…ƒç´ å®šä½

### 2.2 ä¸»è¿›ç¨‹æŠ€æœ¯

```
Electron 37.3.1       - è·¨å¹³å°æ¡Œé¢æ¡†æ¶
Node.js               - è¿è¡Œæ—¶ç¯å¢ƒ
Better-SQLite3 12.4.1 - åµŒå…¥å¼æ•°æ®åº“
Express 5.1.0         - WebUI æœåŠ¡å™¨
WebSocket (ws 8.18.3) - å®æ—¶é€šä¿¡
```

**æ ¸å¿ƒä¾èµ–**:

- `@office-ai/aioncli-core` - Gemini CLI æ ¸å¿ƒ SDK
- `@office-ai/platform` - å¹³å°æŠ½è±¡å±‚ï¼ˆIPC Bridgeï¼‰
- `@modelcontextprotocol/sdk` - MCP åè®®å®ç°

### 2.3 æ–‡æ¡£å¤„ç†

```
mammoth 1.11.0        - Word æ–‡æ¡£è§£æ
pptx2json 0.0.10      - PowerPoint è§£æ
xlsx-republish 0.20.3 - Excel å¤„ç†
officeparser 5.2.2    - é€šç”¨ Office æ–‡æ¡£è§£æ
sharp 0.34.3          - å›¾åƒå¤„ç†
```

### 2.4 æ„å»ºå·¥å…·

```
Webpack 5             - æ¨¡å—æ‰“åŒ…
TypeScript 5.8.3      - ç±»å‹ç³»ç»Ÿ
Electron Forge 7.8.1  - æ‰“åŒ…å·¥å…·
Electron Builder 26   - åˆ†å‘æ„å»º
ESLint + Prettier     - ä»£ç è´¨é‡
```

---

## 3. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·ç•Œé¢å±‚ (UI Layer)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  æ¡Œé¢åº”ç”¨     â”‚  â”‚  WebUI æ¨¡å¼   â”‚  â”‚  ç§»åŠ¨æµè§ˆå™¨   â”‚          â”‚
â”‚  â”‚  (Electron)  â”‚  â”‚  (Browser)   â”‚  â”‚  (PWA)      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â”‚    IPC Bridge    â”‚   HTTP/WS API    â”‚
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸»è¿›ç¨‹å±‚ (Main Process)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    IPC è·¯ç”±ä¸å¤„ç†                          â”‚  â”‚
â”‚  â”‚  â€¢ geminiConversationBridge  â€¢ acpConversationBridge     â”‚  â”‚
â”‚  â”‚  â€¢ fsBridge  â€¢ dialogBridge  â€¢ mcpServiceBridge          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    æ ¸å¿ƒæœåŠ¡å±‚                              â”‚  â”‚
â”‚  â”‚  â€¢ WorkerManage (è¿›ç¨‹ç®¡ç†)  â€¢ ConfigStorage (é…ç½®)        â”‚  â”‚
â”‚  â”‚  â€¢ ChatStorage (ä¼šè¯)       â€¢ Database (SQLite)          â”‚  â”‚
â”‚  â”‚  â€¢ FileWatcher (æ–‡ä»¶ç›‘å¬)   â€¢ McpService (MCP åè®®)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  Agent ç®¡ç†å™¨å±‚                            â”‚  â”‚
â”‚  â”‚  â€¢ GeminiAgentManager  â€¢ AcpAgentManager                 â”‚  â”‚
â”‚  â”‚  â€¢ CodexAgentManager   â€¢ BaseAgentManager (æŠ½è±¡åŸºç±»)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ Fork/Spawn
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å·¥ä½œè¿›ç¨‹å±‚ (Worker Process)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Gemini Workerâ”‚  â”‚  ACP Worker  â”‚  â”‚ Codex Worker â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ â€¢ GeminiAgentâ”‚  â”‚ â€¢ AcpAdapter â”‚  â”‚ â€¢ CodexCore  â”‚          â”‚
â”‚  â”‚ â€¢ ToolRunner â”‚  â”‚ â€¢ CLI Bridge â”‚  â”‚ â€¢ Sandbox    â”‚          â”‚
â”‚  â”‚ â€¢ SkillMgr   â”‚  â”‚ â€¢ MCP Client â”‚  â”‚ â€¢ ToolExec   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¤–éƒ¨æœåŠ¡å±‚ (External)                        â”‚
â”‚  â€¢ Google Gemini API  â€¢ Claude API  â€¢ OpenAI API               â”‚
â”‚  â€¢ MCP Servers        â€¢ Python/JS Scripts  â€¢ Shell Commands    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è¿›ç¨‹æ¨¡å‹

AionUi é‡‡ç”¨ **å¤šè¿›ç¨‹éš”ç¦»æ¶æ„**ï¼Œç¡®ä¿ UI æµç•…æ€§å’Œä»»åŠ¡ç¨³å®šæ€§ï¼š

#### ä¸»è¿›ç¨‹ (Main Process)

- **èŒè´£**: çª—å£ç®¡ç†ã€IPC è·¯ç”±ã€æ•°æ®æŒä¹…åŒ–ã€è¿›ç¨‹è°ƒåº¦
- **æŠ€æœ¯**: Electron Main, Node.js
- **å…³é”®æ–‡ä»¶**: `src/index.ts`, `src/process/`

#### æ¸²æŸ“è¿›ç¨‹ (Renderer Process)

- **èŒè´£**: UI æ¸²æŸ“ã€ç”¨æˆ·äº¤äº’ã€çŠ¶æ€ç®¡ç†
- **æŠ€æœ¯**: React, Arco Design
- **å…³é”®æ–‡ä»¶**: `src/renderer/`

#### å·¥ä½œè¿›ç¨‹ (Worker Process)

- **èŒè´£**: AI ä»»åŠ¡æ‰§è¡Œã€å·¥å…·è°ƒç”¨ã€æ–‡ä»¶æ“ä½œ
- **æŠ€æœ¯**: Node.js Child Process
- **å…³é”®æ–‡ä»¶**: `src/worker/`, `src/agent/`

**è¿›ç¨‹é€šä¿¡æ–¹å¼**:

```typescript
// ä¸»è¿›ç¨‹ â†” æ¸²æŸ“è¿›ç¨‹: IPC Bridge (ç±»å‹å®‰å…¨)
ipcBridge.geminiConversation.sendMessage({ input, conversation_id });

// ä¸»è¿›ç¨‹ â†” å·¥ä½œè¿›ç¨‹: Pipe (JSON-RPC)
pipe.call('agent.send', { message, files });
```

---

## 4. ç›®å½•ç»“æ„è¯¦è§£

### 4.1 æ ¸å¿ƒç›®å½•æ˜ å°„

```
AionUi/
â”œâ”€â”€ src/                          # æºä»£ç æ ¹ç›®å½•
â”‚   â”œâ”€â”€ index.ts                  # ä¸»è¿›ç¨‹å…¥å£ï¼ˆElectron Mainï¼‰
â”‚   â”œâ”€â”€ preload.ts                # é¢„åŠ è½½è„šæœ¬ï¼ˆIPC æ¡¥æ¥ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ renderer/                 # æ¸²æŸ“è¿›ç¨‹ï¼ˆå‰ç«¯ï¼‰
â”‚   â”‚   â”œâ”€â”€ pages/                # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ conversation/     # å¯¹è¯é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ settings/         # è®¾ç½®é¡µé¢
â”‚   â”‚   â”‚   â””â”€â”€ guid/             # å¼•å¯¼é¡µé¢
â”‚   â”‚   â”œâ”€â”€ components/           # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ Markdown.tsx      # Markdown æ¸²æŸ“
â”‚   â”‚   â”‚   â”œâ”€â”€ FilePreview.tsx   # æ–‡ä»¶é¢„è§ˆ
â”‚   â”‚   â”‚   â””â”€â”€ SettingsModal/    # è®¾ç½®æ¨¡æ€æ¡†
â”‚   â”‚   â”œâ”€â”€ hooks/                # React Hooks
â”‚   â”‚   â”œâ”€â”€ context/              # Context API
â”‚   â”‚   â”œâ”€â”€ i18n/                 # å›½é™…åŒ–
â”‚   â”‚   â””â”€â”€ utils/                # å·¥å…·å‡½æ•°
â”‚   â”‚
â”‚   â”œâ”€â”€ process/                  # ä¸»è¿›ç¨‹ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ bridge/               # IPC æ¡¥æ¥å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ geminiConversationBridge.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ acpConversationBridge.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ fsBridge.ts
â”‚   â”‚   â”‚   â””â”€â”€ mcpServiceBridge.ts
â”‚   â”‚   â”œâ”€â”€ database/             # SQLite æ•°æ®åº“
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts          # æ•°æ®åº“æ ¸å¿ƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ migrations/       # æ•°æ®åº“è¿ç§»
â”‚   â”‚   â”‚   â””â”€â”€ types.ts          # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ services/             # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ mcpServices/      # MCP åè®®æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ task/                 # Agent ç®¡ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ BaseAgentManager.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ GeminiAgentManager.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ AcpAgentManager.ts
â”‚   â”‚   â”‚   â””â”€â”€ CodexAgentManager.ts
â”‚   â”‚   â”œâ”€â”€ initStorage.ts        # å­˜å‚¨åˆå§‹åŒ–
â”‚   â”‚   â””â”€â”€ WorkerManage.ts       # å·¥ä½œè¿›ç¨‹ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ worker/                   # å·¥ä½œè¿›ç¨‹
â”‚   â”‚   â”œâ”€â”€ gemini.ts             # Gemini Worker å…¥å£
â”‚   â”‚   â”œâ”€â”€ acp.ts                # ACP Worker å…¥å£
â”‚   â”‚   â”œâ”€â”€ codex.ts              # Codex Worker å…¥å£
â”‚   â”‚   â””â”€â”€ fork/                 # è¿›ç¨‹ Fork å·¥å…·
â”‚   â”‚
â”‚   â”œâ”€â”€ agent/                    # AI ä»£ç†å®ç°
â”‚   â”‚   â”œâ”€â”€ gemini/               # Gemini ä»£ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts          # GeminiAgent æ ¸å¿ƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ cli/              # CLI å·¥å…·é›†æˆ
â”‚   â”‚   â”‚   â””â”€â”€ utils.ts
â”‚   â”‚   â”œâ”€â”€ acp/                  # ACP ä»£ç†ï¼ˆå¤–éƒ¨ CLIï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ AcpAdapter.ts     # CLI é€‚é…å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ AcpConnection.ts  # è¿æ¥ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ AcpDetector.ts    # è‡ªåŠ¨æ£€æµ‹
â”‚   â”‚   â””â”€â”€ codex/                # Codex ä»£ç†
â”‚   â”‚       â”œâ”€â”€ core/             # æ ¸å¿ƒé€»è¾‘
â”‚   â”‚       â”œâ”€â”€ handlers/         # äº‹ä»¶å¤„ç†
â”‚   â”‚       â””â”€â”€ messaging/        # æ¶ˆæ¯åè®®
â”‚   â”‚
â”‚   â”œâ”€â”€ common/                   # å…¬å…±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ ipcBridge.ts          # IPC æ¡¥æ¥å®šä¹‰ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”‚   â”œâ”€â”€ storage.ts            # å­˜å‚¨æŠ½è±¡å±‚
â”‚   â”‚   â”œâ”€â”€ presets/              # é¢„è®¾é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ assistantPresets.ts
â”‚   â”‚   â”œâ”€â”€ types/                # ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ utils/                # å·¥å…·å‡½æ•°
â”‚   â”‚
â”‚   â”œâ”€â”€ webserver/                # WebUI æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ index.ts              # æœåŠ¡å™¨å…¥å£
â”‚   â”‚   â”œâ”€â”€ auth/                 # è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ routes/               # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ middleware/           # ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ websocket/            # WebSocket å¤„ç†
â”‚   â”‚
â”‚   â””â”€â”€ types/                    # å…¨å±€ç±»å‹å®šä¹‰
â”‚
â”œâ”€â”€ assistant/                    # é¢„è®¾åŠ©æ‰‹é…ç½®
â”‚   â”œâ”€â”€ cowork/                   # Cowork åŠ©æ‰‹
â”‚   â”‚   â””â”€â”€ cowork.md
â”‚   â”œâ”€â”€ pptx-generator/           # PPT ç”ŸæˆåŠ©æ‰‹
â”‚   â”œâ”€â”€ ui-ux-pro-max/            # UI/UX è®¾è®¡åŠ©æ‰‹
â”‚   â””â”€â”€ weather-lookup/           # å¤©æ°”æŸ¥è¯¢åŠ©æ‰‹
â”‚
â”œâ”€â”€ skills/                       # æŠ€èƒ½è„šæœ¬åº“
â”‚   â”œâ”€â”€ weather-lookup/           # å¤©æ°”æŸ¥è¯¢æŠ€èƒ½
â”‚   â”‚   â”œâ”€â”€ SKILL.md              # æŠ€èƒ½å®šä¹‰
â”‚   â”‚   â””â”€â”€ weather.py            # Python è„šæœ¬
â”‚   â”œâ”€â”€ pptx/                     # PowerPoint å¤„ç†
â”‚   â”œâ”€â”€ docx/                     # Word å¤„ç†
â”‚   â”œâ”€â”€ pdf/                      # PDF å¤„ç†
â”‚   â””â”€â”€ xlsx/                     # Excel å¤„ç†
â”‚
â”œâ”€â”€ config/                       # æ„å»ºé…ç½®
â”‚   â””â”€â”€ webpack/                  # Webpack é…ç½®
â”‚
â”œâ”€â”€ public/                       # é™æ€èµ„æº
â”œâ”€â”€ resources/                    # åº”ç”¨èµ„æºï¼ˆå›¾æ ‡ç­‰ï¼‰
â”œâ”€â”€ tests/                        # æµ‹è¯•æ–‡ä»¶
â””â”€â”€ scripts/                      # æ„å»ºè„šæœ¬
```

### 4.2 å…³é”®æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶è·¯å¾„                                 | ä½œç”¨                               | é‡è¦æ€§     |
| ---------------------------------------- | ---------------------------------- | ---------- |
| `src/common/ipcBridge.ts`                | IPC é€šä¿¡åè®®å®šä¹‰ï¼Œå‰åç«¯é€šä¿¡çš„æ ¸å¿ƒ | â­â­â­â­â­ |
| `src/process/initStorage.ts`             | å­˜å‚¨åˆå§‹åŒ–ï¼Œæ•°æ®è¿ç§»ï¼Œé¢„è®¾åŠ©æ‰‹åŠ è½½ | â­â­â­â­â­ |
| `src/process/WorkerManage.ts`            | å·¥ä½œè¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†               | â­â­â­â­â­ |
| `src/agent/gemini/index.ts`              | Gemini AI æ ¸å¿ƒé€»è¾‘                 | â­â­â­â­â­ |
| `src/renderer/pages/conversation/`       | å¯¹è¯ç•Œé¢å®ç°                       | â­â­â­â­   |
| `src/webserver/index.ts`                 | WebUI æœåŠ¡å™¨å…¥å£                   | â­â­â­â­   |
| `src/common/presets/assistantPresets.ts` | é¢„è®¾åŠ©æ‰‹é…ç½®                       | â­â­â­     |

---

## 5. æ ¸å¿ƒåŠŸèƒ½ä¸å·¥ä½œæµç¨‹

### 5.1 åº”ç”¨å¯åŠ¨æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Main as ä¸»è¿›ç¨‹
    participant Storage as å­˜å‚¨ç³»ç»Ÿ
    participant Window as æ¸²æŸ“çª—å£
    participant Detector as ACPæ£€æµ‹å™¨

    User->>Main: å¯åŠ¨åº”ç”¨
    Main->>Main: æ£€æŸ¥å¯åŠ¨å‚æ•° (--webui, --resetpass)

    alt WebUI æ¨¡å¼
        Main->>Main: å¯åŠ¨ Express æœåŠ¡å™¨
        Main->>Main: åˆå§‹åŒ– WebSocket
        Main->>User: æ‰“å¼€æµè§ˆå™¨
    else æ¡Œé¢æ¨¡å¼
        Main->>Storage: initStorage()
        Storage->>Storage: æ•°æ®è¿ç§» (temp â†’ userData)
        Storage->>Storage: åˆå§‹åŒ– SQLite æ•°æ®åº“
        Storage->>Storage: å¤åˆ¶å†…ç½®åŠ©æ‰‹è§„åˆ™
        Storage->>Storage: å¤åˆ¶æŠ€èƒ½è„šæœ¬
        Storage->>Storage: åˆå§‹åŒ– MCP é…ç½®
        Storage-->>Main: åˆå§‹åŒ–å®Œæˆ

        Main->>Window: åˆ›å»º BrowserWindow
        Main->>Window: åŠ è½½ index.html
        Window->>Window: React åº”ç”¨å¯åŠ¨
        Window-->>User: æ˜¾ç¤ºç•Œé¢

        Main->>Detector: æ£€æµ‹å¤–éƒ¨ CLI å·¥å…·
        Detector->>Detector: æ‰«æ PATH ç¯å¢ƒå˜é‡
        Detector-->>Main: è¿”å›å¯ç”¨ Agent åˆ—è¡¨
    end
```

**å…³é”®æ­¥éª¤è§£æ**:

1. **å‚æ•°è§£æ** (`src/index.ts`)

   ```typescript
   const isWebUIMode = hasSwitch('webui');
   const isRemoteMode = hasSwitch('remote');
   const isResetPasswordMode = hasCommand('--resetpass');
   ```

2. **å­˜å‚¨åˆå§‹åŒ–** (`src/process/initStorage.ts`)
   - æ•°æ®è¿ç§»ï¼šä»æ—§ç‰ˆ temp ç›®å½•è¿ç§»åˆ° userData/config
   - æ•°æ®åº“åˆå§‹åŒ–ï¼šåˆ›å»º SQLite è¡¨ç»“æ„
   - é¢„è®¾åŠ©æ‰‹ï¼šå¤åˆ¶ `assistant/` ä¸‹çš„è§„åˆ™æ–‡ä»¶åˆ°ç”¨æˆ·ç›®å½•
   - æŠ€èƒ½è„šæœ¬ï¼šå¤åˆ¶ `skills/` åˆ°ç”¨æˆ·é…ç½®ç›®å½•
   - MCP é…ç½®ï¼šåˆå§‹åŒ–é»˜è®¤ MCP æœåŠ¡å™¨é…ç½®

3. **çª—å£åˆ›å»º**
   ```typescript
   mainWindow = new BrowserWindow({
     width: windowWidth,
     height: windowHeight,
     autoHideMenuBar: true,
     titleBarStyle: 'hidden', // macOS è‡ªå®šä¹‰æ ‡é¢˜æ 
     frame: false, // Windows/Linux æ— è¾¹æ¡†
     webPreferences: {
       preload: MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY,
       webviewTag: true, // å¯ç”¨ HTML é¢„è§ˆ
     },
   });
   ```

### 5.2 å¯¹è¯æ¶ˆæ¯æµç¨‹

```mermaid
sequenceDiagram
    participant UI as å‰ç«¯ç•Œé¢
    participant IPC as IPC Bridge
    participant Manager as AgentManager
    participant Worker as Workerè¿›ç¨‹
    participant Agent as GeminiAgent
    participant API as Gemini API

    UI->>IPC: sendMessage({ input, conversation_id })
    IPC->>Manager: è·¯ç”±åˆ°å¯¹åº” Manager
    Manager->>Manager: æŸ¥æ‰¾æˆ–åˆ›å»º Worker
    Manager->>Worker: pipe.call('agent.send', data)

    Worker->>Agent: agent.send(message)
    Agent->>Agent: ç»„è£… Prompt (è§„åˆ™+æŠ€èƒ½+å†å²)
    Agent->>API: å‘é€è¯·æ±‚ (æµå¼)

    loop æµå¼å“åº”
        API-->>Agent: è¿”å›æ•°æ®å— (chunk)
        Agent->>Agent: è§£æ chunk

        alt æ–‡æœ¬å†…å®¹
            Agent-->>Worker: æ–‡æœ¬äº‹ä»¶
            Worker-->>Manager: pipe å›ä¼ 
            Manager-->>IPC: responseStream.emit
            IPC-->>UI: æ›´æ–°ç•Œé¢
        else å·¥å…·è°ƒç”¨
            Agent->>Agent: æ‰§è¡Œå·¥å…· (read_file, run_shell)
            Agent->>Agent: è·å–å·¥å…·ç»“æœ
            Agent->>API: å‘é€å·¥å…·ç»“æœ
        end
    end

    Agent-->>Worker: å®Œæˆäº‹ä»¶
    Worker-->>Manager: å®Œæˆé€šçŸ¥
    Manager->>Manager: ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
    Manager-->>UI: å¯¹è¯ç»“æŸ
```

**æ¶ˆæ¯ç±»å‹**:

```typescript
// å‰ç«¯å‘é€
interface ISendMessageParams {
  input: string; // ç”¨æˆ·è¾“å…¥
  msg_id: string; // æ¶ˆæ¯ ID
  conversation_id: string; // ä¼šè¯ ID
  files?: string[]; // é™„ä»¶è·¯å¾„
  loading_id?: string; // åŠ è½½çŠ¶æ€ ID
}

// åç«¯å“åº”
interface IResponseMessage {
  type: 'text' | 'tool_call' | 'error' | 'done';
  data: unknown;
  msg_id: string;
  conversation_id: string;
}
```

### 5.3 æŠ€èƒ½ç³»ç»Ÿå·¥ä½œæµç¨‹

æŠ€èƒ½ç³»ç»Ÿæ˜¯ AionUi çš„æ ¸å¿ƒæ‰©å±•æœºåˆ¶ï¼Œå…è®¸é€šè¿‡æ–‡ä»¶å®šä¹‰æ–°èƒ½åŠ›ã€‚

#### æŠ€èƒ½å®šä¹‰æ ¼å¼

````markdown
---
name: weather-lookup
description: Retrieve current weather conditions for a specific city
---

# Weather Lookup Skill

## Tools

### weather.py

Location: `skills/weather-lookup/weather.py`

Usage:

```bash
python skills/weather-lookup/weather.py "City Name"
```
````

Output: JSON with temperature, humidity, wind speed

````

#### æŠ€èƒ½åŠ è½½æµç¨‹

```mermaid
sequenceDiagram
    participant Init as åˆå§‹åŒ–
    participant Storage as initStorage
    participant SkillMgr as SkillManager
    participant Agent as GeminiAgent
    participant AI as AIæ¨¡å‹

    Init->>Storage: åº”ç”¨å¯åŠ¨
    Storage->>Storage: å¤åˆ¶ skills/ åˆ°ç”¨æˆ·ç›®å½•
    Storage->>Storage: æ‰«æ SKILL.md æ–‡ä»¶

    Note over Storage: ç”¨æˆ·åˆ›å»ºä¼šè¯æ—¶
    Storage->>SkillMgr: loadSkillsContent(enabledSkills)
    SkillMgr->>SkillMgr: è¯»å– SKILL.md
    SkillMgr->>SkillMgr: è§£æ Frontmatter
    SkillMgr-->>Agent: è¿”å›æŠ€èƒ½æè¿°æ–‡æœ¬

    Agent->>Agent: å°†æŠ€èƒ½æ³¨å…¥ System Prompt
    Agent->>AI: å‘é€å¸¦æŠ€èƒ½çš„ Prompt

    Note over AI: AI å†³å®šä½¿ç”¨æŠ€èƒ½
    AI-->>Agent: è¿”å›å·¥å…·è°ƒç”¨æŒ‡ä»¤
    Agent->>Agent: æ‰§è¡Œ run_shell_command
    Agent->>Agent: python skills/weather-lookup/weather.py "Beijing"
    Agent->>Agent: è·å– JSON ç»“æœ
    Agent->>AI: å‘é€å·¥å…·ç»“æœ
    AI-->>Agent: ç”Ÿæˆæœ€ç»ˆå›å¤
````

#### æŠ€èƒ½ç¼“å­˜æœºåˆ¶

```typescript
// src/process/initStorage.ts
const skillsContentCache = new Map<string, string>();

export const loadSkillsContent = async (enabledSkills: string[]): Promise<string> => {
  // ä½¿ç”¨æ’åºåçš„æŠ€èƒ½åä½œä¸ºç¼“å­˜ key
  const cacheKey = [...enabledSkills].sort().join(',');
  const cached = skillsContentCache.get(cacheKey);
  if (cached !== undefined) {
    return cached;
  }

  // è¯»å–æŠ€èƒ½æ–‡ä»¶å¹¶åˆå¹¶
  const skillContents: string[] = [];
  for (const skillName of enabledSkills) {
    const skillDirFile = path.join(skillsDir, skillName, 'SKILL.md');
    const content = await fs.readFile(skillDirFile, 'utf-8');
    skillContents.push(`## Skill: ${skillName}\n${content}`);
  }

  const result = `[Available Skills]\n${skillContents.join('\n\n')}`;
  skillsContentCache.set(cacheKey, result);
  return result;
};
```

### 5.4 é¢„è®¾åŠ©æ‰‹ç³»ç»Ÿ

é¢„è®¾åŠ©æ‰‹æ˜¯é¢„é…ç½®çš„ AI è§’è‰²ï¼Œå…·æœ‰ç‰¹å®šçš„è§„åˆ™å’ŒæŠ€èƒ½ç»„åˆã€‚

#### åŠ©æ‰‹é…ç½®ç»“æ„

```typescript
// src/common/presets/assistantPresets.ts
export type AssistantPreset = {
  id: string; // å”¯ä¸€æ ‡è¯†
  avatar: string; // å¤´åƒï¼ˆemoji æˆ– SVG è·¯å¾„ï¼‰
  presetAgentType?: 'gemini' | 'claude' | 'codex';
  resourceDir?: string; // èµ„æºç›®å½•
  ruleFiles: Record<string, string>; // è§„åˆ™æ–‡ä»¶ï¼ˆå¤šè¯­è¨€ï¼‰
  skillFiles?: Record<string, string>; // æŠ€èƒ½æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
  nameI18n: Record<string, string>; // åç§°å›½é™…åŒ–
  descriptionI18n: Record<string, string>; // æè¿°å›½é™…åŒ–
};
```

#### å†…ç½®åŠ©æ‰‹åˆ—è¡¨

| åŠ©æ‰‹ ID               | åç§°           | åŠŸèƒ½                             | é»˜è®¤å¯ç”¨ |
| --------------------- | -------------- | -------------------------------- | -------- |
| `cowork`              | Cowork         | è‡ªä¸»ä»»åŠ¡æ‰§è¡Œã€æ–‡ä»¶æ“ä½œã€æ–‡æ¡£å¤„ç† | âœ…       |
| `weather-lookup`      | å¤©æ°”åŠ©æ‰‹       | å®æ—¶å¤©æ°”æŸ¥è¯¢                     | âœ…       |
| `pptx-generator`      | PPT ç”Ÿæˆå™¨     | ç”Ÿæˆ PowerPoint æ–‡ä»¶             | âŒ       |
| `ui-ux-pro-max`       | UI/UX è®¾è®¡å¸ˆ   | ä¸“ä¸š UI è®¾è®¡å»ºè®®                 | âŒ       |
| `game-3d`             | 3D æ¸¸æˆç”Ÿæˆ    | å•æ–‡ä»¶ HTML 3D æ¸¸æˆ              | âŒ       |
| `planning-with-files` | æ–‡ä»¶è§„åˆ’åŠ©æ‰‹   | Manus é£æ ¼ä»»åŠ¡è§„åˆ’               | âŒ       |
| `human-3-coach`       | HUMAN 3.0 æ•™ç»ƒ | ä¸ªäººå‘å±•æŒ‡å¯¼                     | âŒ       |
| `pdf-to-ppt`          | PDF è½¬ PPT     | PDF è½¬æ¢ä¸º PPT                   | âŒ       |

#### åŠ©æ‰‹åˆå§‹åŒ–æµç¨‹

```typescript
// src/process/initStorage.ts
const initBuiltinAssistantRules = async (): Promise<void> => {
  const assistantsDir = getAssistantsDir(); // ~/.config/AionUi/assistants
  const rulesDir = resolveBuiltinDir('rules');
  const builtinSkillsDir = resolveBuiltinDir('skills');
  const userSkillsDir = getSkillsDir();

  // 1. å¤åˆ¶æŠ€èƒ½è„šæœ¬åˆ°ç”¨æˆ·ç›®å½•
  await copyDirectoryRecursively(builtinSkillsDir, userSkillsDir, { overwrite: false });

  // 2. ä¸ºæ¯ä¸ªé¢„è®¾åŠ©æ‰‹å¤åˆ¶è§„åˆ™æ–‡ä»¶
  for (const preset of ASSISTANT_PRESETS) {
    const assistantId = `builtin-${preset.id}`;

    // å¤åˆ¶è§„åˆ™æ–‡ä»¶ï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
    for (const [locale, ruleFile] of Object.entries(preset.ruleFiles)) {
      const sourceRulesPath = path.join(presetRulesDir, ruleFile);
      const targetFileName = `${assistantId}.${locale}.md`;
      const targetPath = path.join(assistantsDir, targetFileName);

      let content = await fs.readFile(sourceRulesPath, 'utf-8');
      // æ›¿æ¢ç›¸å¯¹è·¯å¾„ä¸ºç»å¯¹è·¯å¾„
      content = content.replace(/skills\//g, userSkillsDir + '/');
      await fs.writeFile(targetPath, content, 'utf-8');
    }
  }
};
```

### 5.5 MCP (Model Context Protocol) é›†æˆ

MCP æ˜¯ä¸€ä¸ªæ ‡å‡†åŒ–åè®®ï¼Œå…è®¸ AI æ¨¡å‹è®¿é—®å¤–éƒ¨å·¥å…·å’Œæ•°æ®æºã€‚

#### MCP æœåŠ¡å™¨é…ç½®

```typescript
// src/common/storage.ts
export interface IMcpServer {
  id: string;
  name: string;
  description?: string;
  enabled: boolean; // æ˜¯å¦å·²å®‰è£…åˆ° CLI agents
  transport: IMcpServerTransport;
  tools?: IMcpTool[];
  status?: 'connected' | 'disconnected' | 'error' | 'testing';
  lastConnected?: number;
  createdAt: number;
  updatedAt: number;
  originalJson: string; // åŸå§‹ JSON é…ç½®
}

export type IMcpServerTransport = { type: 'stdio'; command: string; args?: string[]; env?: Record<string, string> } | { type: 'sse'; url: string; headers?: Record<string, string> } | { type: 'http'; url: string; headers?: Record<string, string> };
```

#### é»˜è®¤ MCP æœåŠ¡å™¨

```typescript
// src/process/initStorage.ts
const getDefaultMcpServers = (): IMcpServer[] => {
  return [
    {
      id: `mcp_default_${Date.now()}_0`,
      name: 'chrome-devtools',
      description: 'Default MCP server: chrome-devtools',
      enabled: false, // é»˜è®¤ä¸å¯ç”¨ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨å¼€å¯
      transport: {
        type: 'stdio',
        command: 'npx',
        args: ['-y', 'chrome-devtools-mcp@latest'],
      },
      createdAt: Date.now(),
      updatedAt: Date.now(),
      originalJson: JSON.stringify({ 'chrome-devtools': { command: 'npx', args: ['-y', 'chrome-devtools-mcp@latest'] } }, null, 2),
    },
  ];
};
```

#### MCP å·¥ä½œæµç¨‹

```mermaid
sequenceDiagram
    participant UI as è®¾ç½®ç•Œé¢
    participant Bridge as mcpServiceBridge
    participant Service as McpService
    participant Agent as CLI Agent
    participant MCP as MCP Server

    UI->>Bridge: testMcpConnection(server)
    Bridge->>Service: æµ‹è¯•è¿æ¥
    Service->>MCP: å¯åŠ¨ MCP è¿›ç¨‹ (stdio)
    MCP-->>Service: è¿”å›å·¥å…·åˆ—è¡¨
    Service-->>UI: { success: true, tools: [...] }

    UI->>Bridge: syncMcpToAgents(servers, agents)
    Bridge->>Service: åŒæ­¥é…ç½®

    loop æ¯ä¸ª Agent
        Service->>Agent: å†™å…¥ mcp.json é…ç½®æ–‡ä»¶
        Agent-->>Service: é…ç½®æˆåŠŸ
    end

    Service-->>UI: { success: true, results: [...] }

    Note over Agent,MCP: ç”¨æˆ·ä½¿ç”¨ Agent æ—¶
    Agent->>MCP: è°ƒç”¨ MCP å·¥å…·
    MCP-->>Agent: è¿”å›å·¥å…·ç»“æœ
```

### 5.6 æ–‡ä»¶é¢„è§ˆç³»ç»Ÿ

æ”¯æŒ 9+ ç§æ–‡ä»¶æ ¼å¼çš„å®æ—¶é¢„è§ˆå’Œç¼–è¾‘ã€‚

#### æ”¯æŒçš„æ ¼å¼

| æ ¼å¼         | é¢„è§ˆæ–¹å¼     | ç¼–è¾‘æ”¯æŒ | å®ç°åº“                      |
| ------------ | ------------ | -------- | --------------------------- |
| **Markdown** | æ¸²æŸ“ + æºç   | âœ…       | react-markdown + CodeMirror |
| **ä»£ç **     | è¯­æ³•é«˜äº®     | âœ…       | Monaco Editor               |
| **HTML**     | å®æ—¶æ¸²æŸ“     | âœ…       | iframe + CodeMirror         |
| **PDF**      | åµŒå…¥å¼æŸ¥çœ‹å™¨ | âŒ       | Browser Native              |
| **Word**     | HTML è½¬æ¢    | âŒ       | mammoth.js                  |
| **Excel**    | è¡¨æ ¼æ¸²æŸ“     | âŒ       | xlsx-republish              |
| **PPT**      | JSON è§£æ    | âŒ       | pptx2json                   |
| **å›¾ç‰‡**     | åŸç”Ÿæ˜¾ç¤º     | âŒ       | img tag                     |
| **Diff**     | å·®å¼‚å¯¹æ¯”     | âŒ       | diff2html                   |

#### æ–‡ä»¶ç›‘å¬æœºåˆ¶

```typescript
// src/process/bridge/fileWatchBridge.ts
const watchers = new Map<string, FSWatcher>();

ipcBridge.fileWatch.startWatch.provider(async ({ filePath }) => {
  if (watchers.has(filePath)) {
    return { success: true, msg: 'Already watching' };
  }

  const watcher = fs.watch(filePath, (eventType) => {
    // é€šçŸ¥å‰ç«¯æ–‡ä»¶å·²å˜åŒ–
    ipcBridge.fileWatch.fileChanged.emit({ filePath, eventType });
  });

  watchers.set(filePath, watcher);
  return { success: true };
});
```

#### æ–‡ä»¶æµå¼æ›´æ–°

```typescript
// Agent å†™å…¥æ–‡ä»¶æ—¶å®æ—¶æ¨é€å†…å®¹
ipcBridge.fileStream.contentUpdate.emit({
  filePath: '/path/to/file.md',
  content: 'New content...',
  workspace: '/workspace',
  relativePath: 'file.md',
  operation: 'write',
});
```

---

## 6. å…³é”®è®¾è®¡æ¨¡å¼

### 6.1 Bridge æ¨¡å¼ (Type-Safe IPC)

AionUi æ²¡æœ‰ç›´æ¥ä½¿ç”¨ Electron çš„ `ipcMain.on` å’Œ `ipcRenderer.send`ï¼Œè€Œæ˜¯å°è£…äº†ç±»å‹å®‰å…¨çš„ Bridge ç³»ç»Ÿã€‚

#### Bridge å®šä¹‰

```typescript
// src/common/ipcBridge.ts
import { bridge } from '@office-ai/platform';

export const geminiConversation = {
  sendMessage: bridge.buildProvider<IBridgeResponse<{}>, ISendMessageParams>('chat.send.message'),
  confirmMessage: bridge.buildProvider<IBridgeResponse, IConfirmMessageParams>('input.confirm.message'),
  responseStream: bridge.buildEmitter<IResponseMessage>('chat.response.stream'),
};
```

#### Bridge å®ç°

```typescript
// src/process/bridge/geminiConversationBridge.ts
ipcBridge.geminiConversation.sendMessage.provider(async (params) => {
  const { conversation_id, input, msg_id, files } = params;

  // è·å–æˆ–åˆ›å»º Agent Manager
  const task = await WorkerManage.getTaskByIdRollbackBuild(conversation_id);

  // å‘é€æ¶ˆæ¯åˆ° Worker
  await task.send({ input, msg_id, files });

  return { success: true };
});
```

#### ä¼˜åŠ¿

1. **ç±»å‹å®‰å…¨**: TypeScript è‡ªåŠ¨æ¨æ–­å‚æ•°å’Œè¿”å›å€¼ç±»å‹
2. **ç»Ÿä¸€æ¥å£**: å‰åç«¯ä½¿ç”¨ç›¸åŒçš„ API å®šä¹‰
3. **æ˜“äºç»´æŠ¤**: ä¿®æ”¹æ¥å£æ—¶ç¼–è¯‘å™¨ä¼šæç¤ºæ‰€æœ‰è°ƒç”¨ç‚¹
4. **è‡ªåŠ¨è¡¥å…¨**: IDE æä¾›å®Œæ•´çš„ä»£ç æç¤º

### 6.2 Agent Manager æ¨¡å¼

æ‰€æœ‰ AI ä»£ç†éƒ½ç»§æ‰¿è‡ª `BaseAgentManager`ï¼Œå®ç°ç»Ÿä¸€çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

#### åŸºç±»å®šä¹‰

```typescript
// src/process/task/BaseAgentManager.ts
export default abstract class BaseAgentManager<T> {
  abstract type: 'gemini' | 'acp' | 'codex';
  protected pipe: Pipe;
  protected conversation_id: string;

  constructor(conversation_id: string) {
    this.conversation_id = conversation_id;
    this.pipe = this.createPipe();
  }

  abstract createPipe(): Pipe;
  abstract send(params: T): Promise<void>;
  abstract kill(): void;
}
```

#### å…·ä½“å®ç°

```typescript
// src/process/task/GeminiAgentManager.ts
export class GeminiAgentManager extends BaseAgentManager<ISendParams> {
  type = 'gemini' as const;

  createPipe(): Pipe {
    return fork(path.join(__dirname, '../worker/gemini.js'), {
      workspace: this.workspace,
      conversation_id: this.conversation_id,
      // ... å…¶ä»–é…ç½®
    });
  }

  async send(params: ISendParams): Promise<void> {
    await this.pipe.call('agent.send', params);
  }

  kill(): void {
    this.pipe.kill();
  }
}
```

### 6.3 é¢„è®¾ç³»ç»Ÿ (Preset System)

é€šè¿‡é…ç½®åŒ–æ•°æ®é©±åŠ¨åŠ©æ‰‹å’ŒæŠ€èƒ½çš„åˆ›å»ºã€‚

#### é…ç½®é©±åŠ¨

```typescript
// src/common/presets/assistantPresets.ts
export const ASSISTANT_PRESETS: AssistantPreset[] = [
  {
    id: 'cowork',
    avatar: 'cowork.svg',
    presetAgentType: 'gemini',
    resourceDir: 'assistant/cowork',
    ruleFiles: {
      'en-US': 'cowork.md',
      'zh-CN': 'cowork.md',
    },
    nameI18n: {
      'en-US': 'Cowork',
      'zh-CN': 'Cowork',
    },
    descriptionI18n: {
      'en-US': 'Autonomous task execution with file operations',
      'zh-CN': 'å…·æœ‰æ–‡ä»¶æ“ä½œçš„è‡ªä¸»ä»»åŠ¡æ‰§è¡ŒåŠ©æ‰‹',
    },
  },
  // ... æ›´å¤šé¢„è®¾
];
```

#### è‡ªåŠ¨åˆå§‹åŒ–

```typescript
// src/process/initStorage.ts
const getBuiltinAssistants = (): AcpBackendConfig[] => {
  return ASSISTANT_PRESETS.map((preset) => ({
    id: `builtin-${preset.id}`,
    name: preset.nameI18n['en-US'],
    nameI18n: preset.nameI18n,
    description: preset.descriptionI18n['en-US'],
    descriptionI18n: preset.descriptionI18n,
    avatar: preset.avatar,
    enabled: preset.id === 'cowork' || preset.id === 'weather-lookup',
    isPreset: true,
    isBuiltin: true,
    presetAgentType: preset.presetAgentType || 'gemini',
  }));
};
```

### 6.4 å·¥ä½œè¿›ç¨‹éš”ç¦»æ¨¡å¼

é€šè¿‡ Node.js Child Process éš”ç¦» AI ä»»åŠ¡æ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸»è¿›ç¨‹ã€‚

#### è¿›ç¨‹åˆ›å»º

```typescript
// src/process/task/GeminiAgentManager.ts
import { fork } from '@/process/utils/fork';

createPipe(): Pipe {
  return fork(path.join(__dirname, '../worker/gemini.js'), {
    workspace: this.workspace,
    conversation_id: this.conversation_id,
    model: this.model,
    presetRules: this.presetRules,
    enabledSkills: this.enabledSkills,
  });
}
```

#### Worker å…¥å£

```typescript
// src/worker/gemini.ts
import { GeminiAgent } from '@/agent/gemini';

const agent = new GeminiAgent({
  workspace: process.env.WORKSPACE,
  conversation_id: process.env.CONVERSATION_ID,
  model: JSON.parse(process.env.MODEL),
});

// ç›‘å¬ä¸»è¿›ç¨‹æ¶ˆæ¯
process.on('message', async (msg) => {
  if (msg.method === 'agent.send') {
    await agent.send(msg.params);
  }
});
```

#### è¿›ç¨‹é€šä¿¡

```typescript
// Pipe å°è£…
class Pipe {
  private child: ChildProcess;

  call(method: string, params: unknown): Promise<unknown> {
    return new Promise((resolve, reject) => {
      const id = generateId();
      this.child.send({ id, method, params });

      const handler = (msg: any) => {
        if (msg.id === id) {
          this.child.off('message', handler);
          if (msg.error) reject(msg.error);
          else resolve(msg.result);
        }
      };

      this.child.on('message', handler);
    });
  }

  kill(): void {
    this.child.kill();
  }
}
```

---

## 7. æ•°æ®å­˜å‚¨æ¶æ„

### 7.1 æ··åˆå­˜å‚¨ç­–ç•¥

AionUi é‡‡ç”¨ **SQLite + JSON æ–‡ä»¶** çš„æ··åˆå­˜å‚¨æ–¹æ¡ˆï¼š

| æ•°æ®ç±»å‹     | å­˜å‚¨æ–¹å¼      | ä½ç½®                                            | åŸå›                  |
| ------------ | ------------- | ----------------------------------------------- | -------------------- |
| **ä¼šè¯åˆ—è¡¨** | SQLite + JSON | `~/.config/AionUi/aionui-chat.txt`              | åŒé‡ä¿éšœï¼Œå‘åå…¼å®¹   |
| **æ¶ˆæ¯å†å²** | SQLite + JSON | `~/.config/AionUi/aionui-chat-history/{id}.txt` | å¤§æ•°æ®é‡ï¼Œåˆ†æ–‡ä»¶å­˜å‚¨ |
| **ç³»ç»Ÿé…ç½®** | JSON          | `~/.config/AionUi/aionui-config.txt`            | é…ç½®é¡¹é¢‘ç¹è¯»å†™       |
| **ç¯å¢ƒå˜é‡** | JSON          | `~/.config/AionUi/.aionui-env`                  | ç”¨æˆ·è‡ªå®šä¹‰è·¯å¾„       |
| **ç”¨æˆ·è®¤è¯** | SQLite        | `~/.config/AionUi/aionui.db`                    | WebUI æ¨¡å¼éœ€è¦       |

### 7.2 æ•°æ®åº“è®¾è®¡

#### è¡¨ç»“æ„

```sql
-- ä¼šè¯è¡¨
CREATE TABLE conversations (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL,  -- 'gemini' | 'acp' | 'codex'
  model TEXT,          -- JSON åºåˆ—åŒ–çš„æ¨¡å‹é…ç½®
  extra TEXT,          -- JSON åºåˆ—åŒ–çš„é¢å¤–é…ç½®
  status TEXT,
  create_time INTEGER NOT NULL,
  modify_time INTEGER NOT NULL
);

-- æ¶ˆæ¯è¡¨
CREATE TABLE messages (
  id TEXT PRIMARY KEY,
  conversation_id TEXT NOT NULL,
  role TEXT NOT NULL,  -- 'user' | 'assistant' | 'system'
  content TEXT,
  files TEXT,          -- JSON æ•°ç»„
  tool_calls TEXT,     -- JSON æ•°ç»„
  create_time INTEGER NOT NULL,
  FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE
);

-- ç”¨æˆ·è¡¨ (WebUI)
CREATE TABLE users (
  id TEXT PRIMARY KEY,
  username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- è¿ç§»å†å²è¡¨
CREATE TABLE migration_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  version TEXT UNIQUE NOT NULL,
  applied_at INTEGER NOT NULL
);
```

#### æ•°æ®åº“æ“ä½œ

```typescript
// src/process/database/index.ts
export class AionUIDatabase {
  private db: Database;

  constructor(dbPath: string) {
    this.db = new Database(dbPath);
    this.db.pragma('journal_mode = WAL'); // å†™å‰æ—¥å¿—æ¨¡å¼ï¼Œæå‡å¹¶å‘æ€§èƒ½
  }

  // åˆ›å»ºä¼šè¯
  createConversation(conversation: TChatConversation): IQueryResult<TChatConversation> {
    const row = conversationToRow(conversation);
    const stmt = this.db.prepare(`
      INSERT INTO conversations (id, name, type, model, extra, status, create_time, modify_time)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `);

    try {
      stmt.run(row.id, row.name, row.type, row.model, row.extra, row.status, row.create_time, row.modify_time);
      return { success: true, data: conversation };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  // åˆ†é¡µæŸ¥è¯¢ä¼šè¯
  getConversations(page = 1, pageSize = 20): IPaginatedResult<TChatConversation> {
    const offset = (page - 1) * pageSize;
    const stmt = this.db.prepare(`
      SELECT * FROM conversations
      ORDER BY modify_time DESC
      LIMIT ? OFFSET ?
    `);

    const rows = stmt.all(pageSize, offset) as IConversationRow[];
    const conversations = rows.map(rowToConversation);

    const countStmt = this.db.prepare('SELECT COUNT(*) as total FROM conversations');
    const { total } = countStmt.get() as { total: number };

    return {
      success: true,
      data: conversations,
      pagination: {
        page,
        pageSize,
        total,
        totalPages: Math.ceil(total / pageSize),
      },
    };
  }
}
```

### 7.3 æ•°æ®è¿ç§»æœºåˆ¶

#### è¿ç§»æ–‡ä»¶ç»“æ„

```
src/process/database/migrations/
â”œâ”€â”€ 001_initial_schema.ts      # åˆå§‹è¡¨ç»“æ„
â”œâ”€â”€ 002_add_user_table.ts      # æ·»åŠ ç”¨æˆ·è¡¨
â””â”€â”€ 003_add_indexes.ts         # æ·»åŠ ç´¢å¼•
```

#### è¿ç§»ç¤ºä¾‹

```typescript
// src/process/database/migrations/001_initial_schema.ts
export const migration_001: IMigration = {
  version: '001',
  name: 'initial_schema',
  up: (db: Database) => {
    db.exec(`
      CREATE TABLE IF NOT EXISTS conversations (
        id TEXT PRIMARY KEY,
        name TEXT NOT NULL,
        type TEXT NOT NULL,
        model TEXT,
        extra TEXT,
        status TEXT,
        create_time INTEGER NOT NULL,
        modify_time INTEGER NOT NULL
      );

      CREATE TABLE IF NOT EXISTS messages (
        id TEXT PRIMARY KEY,
        conversation_id TEXT NOT NULL,
        role TEXT NOT NULL,
        content TEXT,
        files TEXT,
        tool_calls TEXT,
        create_time INTEGER NOT NULL,
        FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE
      );

      CREATE INDEX IF NOT EXISTS idx_messages_conversation_id ON messages(conversation_id);
      CREATE INDEX IF NOT EXISTS idx_conversations_modify_time ON conversations(modify_time DESC);
    `);
  },
  down: (db: Database) => {
    db.exec(`
      DROP TABLE IF EXISTS messages;
      DROP TABLE IF EXISTS conversations;
    `);
  },
};
```

#### è‡ªåŠ¨è¿ç§»

```typescript
// src/process/database/migrations/index.ts
export const runMigrations = (db: Database): void => {
  const migrations = [migration_001, migration_002, migration_003];

  for (const migration of migrations) {
    if (!isMigrationApplied(db, migration.version)) {
      console.log(`Running migration ${migration.version}: ${migration.name}`);
      migration.up(db);
      recordMigration(db, migration.version);
    }
  }
};
```

### 7.4 æ–‡ä»¶å­˜å‚¨æ ¼å¼

#### é…ç½®æ–‡ä»¶ (Base64 ç¼–ç )

```typescript
// src/process/initStorage.ts
const encode = (data: unknown) => {
  return btoa(encodeURIComponent(String(data)));
};

const decode = (base64: string) => {
  return decodeURIComponent(atob(base64));
};

// å†™å…¥
await configFile.set('gemini.config', {
  authType: 'google',
  proxy: 'http://proxy.example.com',
});

// è¯»å–
const config = await configFile.get('gemini.config');
```

#### æ¶ˆæ¯å†å²æ–‡ä»¶

```json
// ~/.config/AionUi/aionui-chat-history/{conversation_id}.txt (è§£ç å)
[
  {
    "id": "msg_123",
    "role": "user",
    "content": "Hello",
    "files": [],
    "createTime": 1706342400000
  },
  {
    "id": "msg_124",
    "role": "assistant",
    "content": "Hi! How can I help you?",
    "createTime": 1706342401000
  }
]
```

---

## 8. æ‰©å±•å¼€å‘æŒ‡å—

### 8.1 æ·»åŠ æ–°çš„é¢„è®¾åŠ©æ‰‹

#### æ­¥éª¤ 1: åˆ›å»ºåŠ©æ‰‹è§„åˆ™æ–‡ä»¶

```bash
# åˆ›å»ºåŠ©æ‰‹ç›®å½•
mkdir -p assistant/my-assistant

# åˆ›å»ºè§„åˆ™æ–‡ä»¶ï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
touch assistant/my-assistant/my-assistant.md
touch assistant/my-assistant/my-assistant.zh-CN.md
```

```markdown
<!-- assistant/my-assistant/my-assistant.md -->

# My Custom Assistant

You are a specialized assistant for [specific task].

## Core Principles

- Principle 1
- Principle 2

## Available Tools

- Tool 1: Description
- Tool 2: Description

## Workflow

1. Step 1
2. Step 2
```

#### æ­¥éª¤ 2: æ³¨å†Œåˆ°é¢„è®¾åˆ—è¡¨

```typescript
// src/common/presets/assistantPresets.ts
export const ASSISTANT_PRESETS: AssistantPreset[] = [
  // ... ç°æœ‰é¢„è®¾
  {
    id: 'my-assistant',
    avatar: 'ğŸ¤–', // æˆ– 'my-icon.svg'
    presetAgentType: 'gemini',
    resourceDir: 'assistant/my-assistant',
    ruleFiles: {
      'en-US': 'my-assistant.md',
      'zh-CN': 'my-assistant.zh-CN.md',
    },
    nameI18n: {
      'en-US': 'My Assistant',
      'zh-CN': 'æˆ‘çš„åŠ©æ‰‹',
    },
    descriptionI18n: {
      'en-US': 'A specialized assistant for specific tasks',
      'zh-CN': 'ä¸“é—¨ç”¨äºç‰¹å®šä»»åŠ¡çš„åŠ©æ‰‹',
    },
  },
];
```

#### æ­¥éª¤ 3: é‡å¯åº”ç”¨

```bash
npm start
```

åº”ç”¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨ï¼š

1. å¤åˆ¶è§„åˆ™æ–‡ä»¶åˆ° `~/.config/AionUi/assistants/`
2. æ³¨å†ŒåŠ©æ‰‹åˆ°é…ç½®ç³»ç»Ÿ
3. åœ¨è®¾ç½®ç•Œé¢æ˜¾ç¤ºæ–°åŠ©æ‰‹

### 8.2 å¼€å‘æ–°æŠ€èƒ½

#### æ­¥éª¤ 1: åˆ›å»ºæŠ€èƒ½ç›®å½•

```bash
mkdir -p skills/my-skill
cd skills/my-skill
```

#### æ­¥éª¤ 2: ç¼–å†™æŠ€èƒ½å®šä¹‰

````markdown
## <!-- skills/my-skill/SKILL.md -->

name: my-skill
description: Brief description of what this skill does

---

# My Skill

Detailed description of the skill.

## Tools

### my_script.py

**Location:** `skills/my-skill/my_script.py`

**Usage:**

```bash
python skills/my-skill/my_script.py <arg1> <arg2>
```
````

**Arguments:**

- `arg1`: Description of argument 1
- `arg2`: Description of argument 2

**Output:**
Returns JSON with the following structure:

```json
{
  "result": "...",
  "status": "success"
}
```

**Example:**

```bash
python skills/my-skill/my_script.py "input" "value"
```

````

#### æ­¥éª¤ 3: å®ç°æŠ€èƒ½è„šæœ¬

```python
# skills/my-skill/my_script.py
import sys
import json

def main():
    if len(sys.argv) < 3:
        print(json.dumps({"error": "Missing arguments"}))
        sys.exit(1)

    arg1 = sys.argv[1]
    arg2 = sys.argv[2]

    # å®ç°ä½ çš„é€»è¾‘
    result = process_data(arg1, arg2)

    # è¿”å› JSON ç»“æœ
    print(json.dumps({
        "result": result,
        "status": "success"
    }))

def process_data(arg1, arg2):
    # ä½ çš„å¤„ç†é€»è¾‘
    return f"Processed: {arg1} + {arg2}"

if __name__ == "__main__":
    main()
````

#### æ­¥éª¤ 4: åœ¨åŠ©æ‰‹ä¸­å¯ç”¨æŠ€èƒ½

```typescript
// åˆ›å»ºä¼šè¯æ—¶æŒ‡å®šå¯ç”¨çš„æŠ€èƒ½
const conversation = await ipcBridge.conversation.create({
  type: 'gemini',
  model: selectedModel,
  extra: {
    workspace: '/path/to/workspace',
    enabledSkills: ['my-skill', 'weather-lookup'], // å¯ç”¨ä½ çš„æŠ€èƒ½
  },
});
```

### 8.3 æ·»åŠ æ–°çš„ IPC æ¥å£

#### æ­¥éª¤ 1: å®šä¹‰æ¥å£

```typescript
// src/common/ipcBridge.ts
export const myFeature = {
  doSomething: bridge.buildProvider<IResult, IParams>('my-feature.do-something'),
  onEvent: bridge.buildEmitter<IEventData>('my-feature.on-event'),
};

interface IParams {
  input: string;
  options?: Record<string, unknown>;
}

interface IResult {
  success: boolean;
  data?: unknown;
  error?: string;
}

interface IEventData {
  type: string;
  payload: unknown;
}
```

#### æ­¥éª¤ 2: å®ç° Bridge

```typescript
// src/process/bridge/myFeatureBridge.ts
import { ipcBridge } from '@/common/ipcBridge';

export const initMyFeatureBridge = () => {
  ipcBridge.myFeature.doSomething.provider(async (params) => {
    try {
      const { input, options } = params;

      // å®ç°ä½ çš„é€»è¾‘
      const result = await processInput(input, options);

      // å‘é€äº‹ä»¶é€šçŸ¥
      ipcBridge.myFeature.onEvent.emit({
        type: 'processing',
        payload: { progress: 50 },
      });

      return {
        success: true,
        data: result,
      };
    } catch (error) {
      return {
        success: false,
        error: error.message,
      };
    }
  });
};

async function processInput(input: string, options?: Record<string, unknown>) {
  // ä½ çš„å¤„ç†é€»è¾‘
  return { processed: input };
}
```

#### æ­¥éª¤ 3: æ³¨å†Œ Bridge

```typescript
// src/process/initBridge.ts
import { initMyFeatureBridge } from './bridge/myFeatureBridge';

export const initBridge = () => {
  // ... ç°æœ‰ bridge åˆå§‹åŒ–
  initMyFeatureBridge();
};
```

#### æ­¥éª¤ 4: å‰ç«¯è°ƒç”¨

```typescript
// src/renderer/pages/MyFeaturePage.tsx
import { ipcBridge } from '@/common/ipcBridge';
import { useEffect } from 'react';

export const MyFeaturePage = () => {
  useEffect(() => {
    // ç›‘å¬äº‹ä»¶
    const unsubscribe = ipcBridge.myFeature.onEvent.subscribe((event) => {
      console.log('Event received:', event);
    });

    return () => unsubscribe();
  }, []);

  const handleClick = async () => {
    const result = await ipcBridge.myFeature.doSomething({
      input: 'test',
      options: { mode: 'fast' },
    });

    if (result.success) {
      console.log('Success:', result.data);
    } else {
      console.error('Error:', result.error);
    }
  };

  return <button onClick={handleClick}>Do Something</button>;
};
```

### 8.4 æ·»åŠ æ–°çš„ AI ä»£ç†ç±»å‹

#### æ­¥éª¤ 1: åˆ›å»º Agent å®ç°

```typescript
// src/agent/myagent/index.ts
export class MyAgent {
  private config: IMyAgentConfig;

  constructor(config: IMyAgentConfig) {
    this.config = config;
  }

  async send(message: string): Promise<void> {
    // å®ç°æ¶ˆæ¯å‘é€é€»è¾‘
    const response = await this.callAPI(message);

    // å‘é€å“åº”äº‹ä»¶
    process.send?.({
      type: 'response',
      data: response,
    });
  }

  private async callAPI(message: string): Promise<string> {
    // è°ƒç”¨ä½ çš„ AI API
    return 'Response from MyAgent';
  }
}
```

#### æ­¥éª¤ 2: åˆ›å»º Worker

```typescript
// src/worker/myagent.ts
import { MyAgent } from '@/agent/myagent';

const agent = new MyAgent({
  apiKey: process.env.API_KEY,
  workspace: process.env.WORKSPACE,
});

process.on('message', async (msg: any) => {
  if (msg.method === 'agent.send') {
    await agent.send(msg.params.input);
  }
});
```

#### æ­¥éª¤ 3: åˆ›å»º Manager

```typescript
// src/process/task/MyAgentManager.ts
import BaseAgentManager from './BaseAgentManager';
import { fork } from '@/process/utils/fork';

export class MyAgentManager extends BaseAgentManager<ISendParams> {
  type = 'myagent' as const;

  createPipe(): Pipe {
    return fork(path.join(__dirname, '../worker/myagent.js'), {
      workspace: this.workspace,
      conversation_id: this.conversation_id,
      apiKey: this.apiKey,
    });
  }

  async send(params: ISendParams): Promise<void> {
    await this.pipe.call('agent.send', params);
  }

  kill(): void {
    this.pipe.kill();
  }
}
```

#### æ­¥éª¤ 4: æ³¨å†Œåˆ° WorkerManage

```typescript
// src/process/WorkerManage.ts
import { MyAgentManager } from './task/MyAgentManager';

const buildConversation = (conversation: TChatConversation) => {
  switch (conversation.type) {
    case 'gemini': return new GeminiAgentManager(...);
    case 'acp': return new AcpAgentManager(...);
    case 'myagent': return new MyAgentManager(...);  // æ·»åŠ ä½ çš„ Agent
    default: return null;
  }
};
```

---

## 9. éƒ¨ç½²ä¸æ„å»º

### 9.1 å¼€å‘ç¯å¢ƒ

#### ç¯å¢ƒè¦æ±‚

```json
{
  "node": ">=18.0.0",
  "npm": ">=9.0.0",
  "python": ">=3.8" // ç”¨äºæŠ€èƒ½è„šæœ¬
}
```

#### å®‰è£…ä¾èµ–

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/iOfficeAI/AionUi.git
cd AionUi

# å®‰è£…ä¾èµ–
npm install

# åº”ç”¨è¡¥ä¸ï¼ˆå¦‚æœæœ‰ï¼‰
npm run postinstall
```

#### å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
# æ¡Œé¢æ¨¡å¼
npm start

# WebUI æ¨¡å¼
npm run webui

# WebUI è¿œç¨‹è®¿é—®æ¨¡å¼
npm run webui:remote
```

#### å¼€å‘å·¥å…·

```bash
# ä»£ç æ£€æŸ¥
npm run lint

# è‡ªåŠ¨ä¿®å¤
npm run lint:fix

# æ ¼å¼åŒ–ä»£ç 
npm run format

# è¿è¡Œæµ‹è¯•
npm test
```

### 9.2 æ„å»ºé…ç½®

#### Webpack é…ç½®

```typescript
// config/webpack/webpack.config.ts
export const mainConfig: Configuration = {
  entry: './src/index.ts',
  target: 'electron-main',
  module: {
    rules: [
      {
        test: /\.ts$/,
        use: 'ts-loader',
        exclude: /node_modules/,
      },
      {
        test: /\.node$/,
        use: 'node-loader',
      },
    ],
  },
  resolve: {
    extensions: ['.ts', '.js'],
    alias: {
      '@': path.resolve(__dirname, '../../src'),
      '@process': path.resolve(__dirname, '../../src/process'),
      '@renderer': path.resolve(__dirname, '../../src/renderer'),
      '@worker': path.resolve(__dirname, '../../src/worker'),
    },
  },
};
```

#### Electron Forge é…ç½®

```typescript
// forge.config.ts
module.exports = {
  packagerConfig: {
    asar: {
      unpack: '**/node_modules/{node-pty,bcrypt,better-sqlite3,@mapbox,detect-libc,prebuild-install,node-gyp-build,bindings,web-tree-sitter,tree-sitter-bash}/**/*',
    },
    executableName: 'AionUi',
    icon: path.resolve(__dirname, 'resources/app'),
    extraResource: [path.resolve(__dirname, 'public')],
  },
  makers: [new MakerDMG({}, ['darwin']), new MakerZIP({}, ['darwin', 'win32']), new MakerWix({}, ['win32']), new MakerDeb({}, ['linux']), new MakerRpm({}, ['linux'])],
  plugins: [
    new WebpackPlugin({
      mainConfig,
      renderer: {
        config: rendererConfig,
        entryPoints: [
          {
            html: './public/index.html',
            js: './src/renderer/index.ts',
            name: 'main_window',
            preload: {
              js: './src/preload.ts',
            },
          },
        ],
      },
    }),
  ],
};
```

### 9.3 æ‰“åŒ…å‘½ä»¤

#### å…¨å¹³å°æ„å»º

```bash
# è‡ªåŠ¨æ£€æµ‹å½“å‰å¹³å°
npm run dist

# æŒ‡å®šå¹³å°
npm run dist:mac
npm run dist:win
npm run dist:linux
```

#### å¹³å°ç‰¹å®šæ„å»º

```bash
# macOS (ARM64 + x64)
npm run build-mac

# macOS ARM64
npm run build-mac:arm64

# macOS x64
npm run build-mac:x64

# Windows
npm run build-win

# Linux (Debian)
npm run build-deb
```

### 9.4 æ„å»ºäº§ç‰©

#### macOS

```
out/
â”œâ”€â”€ make/
â”‚   â”œâ”€â”€ AionUi_1.7.2_arm64.dmg      # ARM64 å®‰è£…åŒ…
â”‚   â”œâ”€â”€ AionUi_1.7.2_x64.dmg        # x64 å®‰è£…åŒ…
â”‚   â””â”€â”€ zip/
â”‚       â”œâ”€â”€ darwin/arm64/AionUi-darwin-arm64-1.7.2.zip
â”‚       â””â”€â”€ darwin/x64/AionUi-darwin-x64-1.7.2.zip
```

#### Windows

```
out/
â”œâ”€â”€ make/
â”‚   â”œâ”€â”€ squirrel.windows/
â”‚   â”‚   â””â”€â”€ AionUi_1.7.2.exe        # Squirrel å®‰è£…åŒ…
â”‚   â”œâ”€â”€ wix/
â”‚   â”‚   â””â”€â”€ AionUi_1.7.2.msi        # MSI å®‰è£…åŒ…
â”‚   â””â”€â”€ zip/
â”‚       â””â”€â”€ win32/x64/AionUi-win32-x64-1.7.2.zip
```

#### Linux

```
out/
â”œâ”€â”€ make/
â”‚   â”œâ”€â”€ deb/
â”‚   â”‚   â””â”€â”€ AionUi_1.7.2_amd64.deb  # Debian åŒ…
â”‚   â”œâ”€â”€ rpm/
â”‚   â”‚   â””â”€â”€ AionUi-1.7.2.x86_64.rpm # RPM åŒ…
â”‚   â””â”€â”€ zip/
â”‚       â””â”€â”€ linux/x64/AionUi-linux-x64-1.7.2.zip
```

### 9.5 CI/CD é…ç½®

#### GitHub Actions ç¤ºä¾‹

```yaml
# .github/workflows/build.yml
name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run build-mac
      - uses: actions/upload-artifact@v3
        with:
          name: mac-builds
          path: out/make/*.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run build-win
      - uses: actions/upload-artifact@v3
        with:
          name: windows-builds
          path: out/make/**/*.exe

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run build-deb
      - uses: actions/upload-artifact@v3
        with:
          name: linux-builds
          path: out/make/**/*.deb
```

### 9.6 ä»£ç ç­¾å

#### macOS ç­¾å

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export APPLE_ID="your-apple-id@example.com"
export APPLE_ID_PASSWORD="app-specific-password"
export APPLE_TEAM_ID="TEAM_ID"

# æ„å»ºå¹¶ç­¾å
npm run build-mac
```

#### Windows ç­¾å

```bash
# è®¾ç½®è¯ä¹¦
export WINDOWS_CERTIFICATE_FILE="path/to/cert.pfx"
export WINDOWS_CERTIFICATE_PASSWORD="password"

# æ„å»ºå¹¶ç­¾å
npm run build-win
```

---

## 10. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 10.1 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### è™šæ‹Ÿæ»šåŠ¨

```typescript
// src/renderer/messages/MessageList.tsx
import { Virtuoso } from 'react-virtuoso';

export const MessageList = ({ messages }: { messages: TMessage[] }) => {
  return (
    <Virtuoso
      data={messages}
      itemContent={(index, message) => (
        <MessageItem key={message.id} message={message} />
      )}
      followOutput="smooth"  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
      initialTopMostItemIndex={messages.length - 1}
    />
  );
};
```

**ä¼˜åŠ¿**:

- åªæ¸²æŸ“å¯è§åŒºåŸŸçš„æ¶ˆæ¯
- æ”¯æŒæ•°åƒæ¡æ¶ˆæ¯æ— å¡é¡¿
- è‡ªåŠ¨å›æ”¶ DOM èŠ‚ç‚¹

#### ä»£ç åˆ†å‰²

```typescript
// src/renderer/router.tsx
import { lazy, Suspense } from 'react';

const ConversationPage = lazy(() => import('./pages/conversation'));
const SettingsPage = lazy(() => import('./pages/settings'));

export const Router = () => (
  <Suspense fallback={<AppLoader />}>
    <Routes>
      <Route path="/conversation/:id" element={<ConversationPage />} />
      <Route path="/settings" element={<SettingsPage />} />
    </Routes>
  </Suspense>
);
```

#### Markdown æ¸²æŸ“ä¼˜åŒ–

```typescript
// src/renderer/components/Markdown.tsx
import { memo } from 'react';
import ReactMarkdown from 'react-markdown';

export const Markdown = memo(({ content }: { content: string }) => {
  return (
    <ReactMarkdown
      remarkPlugins={[remarkGfm, remarkMath]}
      rehypePlugins={[rehypeKatex, rehypeRaw]}
      components={{
        code: CodeBlock,  // è‡ªå®šä¹‰ä»£ç å—ç»„ä»¶
        img: LazyImage,   // æ‡’åŠ è½½å›¾ç‰‡
      }}
    >
      {content}
    </ReactMarkdown>
  );
}, (prev, next) => prev.content === next.content);
```

### 10.2 åç«¯æ€§èƒ½ä¼˜åŒ–

#### æ•°æ®åº“ä¼˜åŒ–

```typescript
// src/process/database/index.ts
export class AionUIDatabase {
  constructor(dbPath: string) {
    this.db = new Database(dbPath);

    // æ€§èƒ½ä¼˜åŒ–é…ç½®
    this.db.pragma('journal_mode = WAL'); // å†™å‰æ—¥å¿—ï¼Œæå‡å¹¶å‘
    this.db.pragma('synchronous = NORMAL'); // å¹³è¡¡æ€§èƒ½å’Œå®‰å…¨
    this.db.pragma('cache_size = -64000'); // 64MB ç¼“å­˜
    this.db.pragma('temp_store = MEMORY'); // ä¸´æ—¶è¡¨å­˜å†…å­˜
    this.db.pragma('mmap_size = 30000000000'); // å†…å­˜æ˜ å°„
  }

  // æ‰¹é‡æ’å…¥ä¼˜åŒ–
  batchInsertMessages(messages: TMessage[]): void {
    const insert = this.db.prepare(`
      INSERT INTO messages (id, conversation_id, role, content, files, tool_calls, create_time)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `);

    const insertMany = this.db.transaction((messages: TMessage[]) => {
      for (const msg of messages) {
        const row = messageToRow(msg);
        insert.run(row.id, row.conversation_id, row.role, row.content, row.files, row.tool_calls, row.create_time);
      }
    });

    insertMany(messages);
  }
}
```

#### æŠ€èƒ½ç¼“å­˜

```typescript
// src/process/initStorage.ts
const skillsContentCache = new Map<string, string>();

export const loadSkillsContent = async (enabledSkills: string[]): Promise<string> => {
  // ä½¿ç”¨æ’åºåçš„æŠ€èƒ½åä½œä¸ºç¼“å­˜ key
  const cacheKey = [...enabledSkills].sort().join(',');
  const cached = skillsContentCache.get(cacheKey);
  if (cached !== undefined) {
    return cached;
  }

  // è¯»å–å¹¶ç¼“å­˜
  const content = await readSkillFiles(enabledSkills);
  skillsContentCache.set(cacheKey, content);
  return content;
};
```

#### Worker è¿›ç¨‹æ± 

```typescript
// src/process/WorkerManage.ts
const MAX_WORKERS = 5;
const workerPool: Map<string, BaseAgentManager<unknown>> = new Map();

const getOrCreateWorker = (conversation_id: string): BaseAgentManager<unknown> => {
  if (workerPool.has(conversation_id)) {
    return workerPool.get(conversation_id)!;
  }

  // å¦‚æœè¾¾åˆ°ä¸Šé™ï¼Œæ¸…ç†æœ€æ—§çš„ Worker
  if (workerPool.size >= MAX_WORKERS) {
    const oldestId = Array.from(workerPool.keys())[0];
    const oldestWorker = workerPool.get(oldestId);
    oldestWorker?.kill();
    workerPool.delete(oldestId);
  }

  const worker = createWorker(conversation_id);
  workerPool.set(conversation_id, worker);
  return worker;
};
```

### 10.3 å†…å­˜ä¼˜åŒ–

#### æ¶ˆæ¯å†å²åˆ†é¡µåŠ è½½

```typescript
// src/renderer/hooks/useMessages.ts
export const useMessages = (conversation_id: string) => {
  const [messages, setMessages] = useState<TMessage[]>([]);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);

  const loadMore = async () => {
    const result = await ipcBridge.database.getConversationMessages({
      conversation_id,
      page,
      pageSize: 50,
    });

    if (result.length < 50) {
      setHasMore(false);
    }

    setMessages((prev) => [...result, ...prev]);
    setPage((p) => p + 1);
  };

  return { messages, loadMore, hasMore };
};
```

#### æ–‡ä»¶æµå¼è¯»å–

```typescript
// src/process/bridge/fsBridge.ts
ipcBridge.fs.readFile.provider(async ({ path }) => {
  const stats = await fs.stat(path);

  // å¤§æ–‡ä»¶ä½¿ç”¨æµå¼è¯»å–
  if (stats.size > 10 * 1024 * 1024) {
    // 10MB
    const stream = fs.createReadStream(path, { encoding: 'utf-8' });
    let content = '';

    for await (const chunk of stream) {
      content += chunk;

      // æ¯ 1MB å‘é€ä¸€æ¬¡è¿›åº¦äº‹ä»¶
      if (content.length % (1024 * 1024) === 0) {
        ipcBridge.fs.readProgress.emit({
          path,
          progress: content.length / stats.size,
        });
      }
    }

    return content;
  }

  // å°æ–‡ä»¶ç›´æ¥è¯»å–
  return await fs.readFile(path, 'utf-8');
});
```

### 10.4 ç½‘ç»œä¼˜åŒ–

#### API è¯·æ±‚ç¼“å­˜

```typescript
// src/common/RotatingApiClient.ts
export class RotatingApiClient {
  private cache = new Map<string, { data: unknown; timestamp: number }>();
  private CACHE_TTL = 5 * 60 * 1000; // 5 åˆ†é’Ÿ

  async request<T>(url: string, options?: RequestInit): Promise<T> {
    const cacheKey = `${url}:${JSON.stringify(options)}`;
    const cached = this.cache.get(cacheKey);

    if (cached && Date.now() - cached.timestamp < this.CACHE_TTL) {
      return cached.data as T;
    }

    const response = await fetch(url, options);
    const data = await response.json();

    this.cache.set(cacheKey, { data, timestamp: Date.now() });
    return data;
  }
}
```

#### WebSocket å¿ƒè·³

```typescript
// src/webserver/websocket/index.ts
export const setupWebSocket = (wss: WebSocketServer) => {
  wss.on('connection', (ws) => {
    let isAlive = true;

    ws.on('pong', () => {
      isAlive = true;
    });

    const interval = setInterval(() => {
      if (!isAlive) {
        ws.terminate();
        return;
      }

      isAlive = false;
      ws.ping();
    }, 30000); // 30 ç§’å¿ƒè·³

    ws.on('close', () => {
      clearInterval(interval);
    });
  });
};
```

### 10.5 æ„å»ºä¼˜åŒ–

#### Webpack é…ç½®

```typescript
// config/webpack/webpack.config.ts
export const mainConfig: Configuration = {
  optimization: {
    minimize: true,
    minimizer: [
      new TerserPlugin({
        terserOptions: {
          compress: {
            drop_console: true, // ç§»é™¤ console.log
            drop_debugger: true,
          },
        },
      }),
    ],
  },
  externals: {
    // ä¸æ‰“åŒ…å¤§å‹ä¾èµ–
    'better-sqlite3': 'commonjs better-sqlite3',
    sharp: 'commonjs sharp',
  },
};
```

#### ä»£ç åˆ†å‰²

```typescript
// config/webpack/webpack.renderer.config.ts
export const rendererConfig: Configuration = {
  optimization: {
    splitChunks: {
      chunks: 'all',
      cacheGroups: {
        vendor: {
          test: /[\\/]node_modules[\\/]/,
          name: 'vendors',
          priority: 10,
        },
        arco: {
          test: /[\\/]node_modules[\\/]@arco-design[\\/]/,
          name: 'arco',
          priority: 20,
        },
        monaco: {
          test: /[\\/]node_modules[\\/]monaco-editor[\\/]/,
          name: 'monaco',
          priority: 20,
        },
      },
    },
  },
};
```

---

## 11. å®‰å…¨æ€§è®¾è®¡

### 11.1 WebUI è®¤è¯ç³»ç»Ÿ

#### å¯†ç åŠ å¯†

```typescript
// src/webserver/auth/service/AuthService.ts
import bcrypt from 'bcrypt';

export class AuthService {
  private static readonly SALT_ROUNDS = 12;

  static async hashPassword(password: string): Promise<string> {
    return await bcrypt.hash(password, this.SALT_ROUNDS);
  }

  static async verifyPassword(password: string, hash: string): Promise<boolean> {
    return await bcrypt.compare(password, hash);
  }

  static generateRandomPassword(): string {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
    let password = '';
    for (let i = 0; i < 12; i++) {
      password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
  }
}
```

#### JWT Token

```typescript
// src/webserver/auth/service/AuthService.ts
import jwt from 'jsonwebtoken';

export class AuthService {
  private static jwtSecret: string = crypto.randomBytes(64).toString('hex');

  static generateToken(userId: string, username: string): string {
    return jwt.sign({ userId, username }, this.jwtSecret, { expiresIn: '7d' });
  }

  static verifyToken(token: string): { userId: string; username: string } | null {
    try {
      return jwt.verify(token, this.jwtSecret) as { userId: string; username: string };
    } catch {
      return null;
    }
  }

  static rotateSecret(): void {
    this.jwtSecret = crypto.randomBytes(64).toString('hex');
  }
}
```

#### è®¤è¯ä¸­é—´ä»¶

```typescript
// src/webserver/middleware/auth.ts
export const authMiddleware = (req: Request, res: Response, next: NextFunction) => {
  const token = req.cookies.auth_token;

  if (!token) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  const payload = AuthService.verifyToken(token);
  if (!payload) {
    return res.status(401).json({ error: 'Invalid token' });
  }

  req.user = payload;
  next();
};
```

### 11.2 CSRF é˜²æŠ¤

```typescript
// src/webserver/middleware/csrf.ts
import csrf from 'tiny-csrf';

export const setupCsrf = (app: Express) => {
  app.use(csrf('csrf-secret-key', ['POST', 'PUT', 'DELETE']));

  app.use((req, res, next) => {
    res.locals.csrfToken = req.csrfToken();
    next();
  });
};
```

### 11.3 é€Ÿç‡é™åˆ¶

```typescript
// src/webserver/middleware/rateLimit.ts
import rateLimit from 'express-rate-limit';

export const loginRateLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 åˆ†é’Ÿ
  max: 5, // æœ€å¤š 5 æ¬¡å°è¯•
  message: 'Too many login attempts, please try again later',
  standardHeaders: true,
  legacyHeaders: false,
});

export const apiRateLimiter = rateLimit({
  windowMs: 1 * 60 * 1000, // 1 åˆ†é’Ÿ
  max: 100, // æœ€å¤š 100 æ¬¡è¯·æ±‚
  message: 'Too many requests, please slow down',
});
```

### 11.4 æ–‡ä»¶ç³»ç»Ÿå®‰å…¨

#### è·¯å¾„éªŒè¯

```typescript
// src/process/bridge/fsBridge.ts
import path from 'path';

const isPathSafe = (filePath: string, workspace: string): boolean => {
  const resolvedPath = path.resolve(filePath);
  const resolvedWorkspace = path.resolve(workspace);

  // ç¡®ä¿æ–‡ä»¶åœ¨å·¥ä½œç©ºé—´å†…
  return resolvedPath.startsWith(resolvedWorkspace);
};

ipcBridge.fs.readFile.provider(async ({ path: filePath }) => {
  const workspace = getWorkspace();

  if (!isPathSafe(filePath, workspace)) {
    throw new Error('Access denied: File outside workspace');
  }

  return await fs.readFile(filePath, 'utf-8');
});
```

#### Shell å‘½ä»¤æ³¨å…¥é˜²æŠ¤

```typescript
// src/agent/gemini/cli/tools/shell.ts
import { spawn } from 'child_process';

export const runShellCommand = async (command: string): Promise<string> => {
  // ç¦æ­¢å±é™©å‘½ä»¤
  const dangerousPatterns = [/rm\s+-rf\s+\//, /sudo/, /chmod\s+777/, />\s*\/dev\/sda/];

  for (const pattern of dangerousPatterns) {
    if (pattern.test(command)) {
      throw new Error('Dangerous command detected');
    }
  }

  // ä½¿ç”¨ spawn è€Œä¸æ˜¯ execï¼Œé¿å… shell æ³¨å…¥
  const [cmd, ...args] = command.split(' ');
  const child = spawn(cmd, args, {
    cwd: getWorkspace(),
    shell: false, // ä¸ä½¿ç”¨ shell
  });

  let output = '';
  child.stdout.on('data', (data) => {
    output += data.toString();
  });

  return new Promise((resolve, reject) => {
    child.on('close', (code) => {
      if (code === 0) resolve(output);
      else reject(new Error(`Command failed with code ${code}`));
    });
  });
};
```

### 11.5 æ•°æ®åŠ å¯†

#### é…ç½®æ–‡ä»¶åŠ å¯†

```typescript
// src/process/initStorage.ts
const encode = (data: unknown) => {
  return btoa(encodeURIComponent(String(data)));
};

const decode = (base64: string) => {
  return decodeURIComponent(atob(base64));
};

// æ•æ„Ÿé…ç½®åŠ å¯†å­˜å‚¨
const encryptSensitiveData = (data: string): string => {
  const cipher = crypto.createCipher('aes-256-cbc', getEncryptionKey());
  let encrypted = cipher.update(data, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return encrypted;
};

const decryptSensitiveData = (encrypted: string): string => {
  const decipher = crypto.createDecipher('aes-256-cbc', getEncryptionKey());
  let decrypted = decipher.update(encrypted, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  return decrypted;
};
```

---

## 12. æ•…éšœæ’æŸ¥æŒ‡å—

### 12.1 å¸¸è§é—®é¢˜

#### é—®é¢˜ 1: åº”ç”¨æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**: åŒå‡»åº”ç”¨å›¾æ ‡åæ— å“åº”

**æ’æŸ¥æ­¥éª¤**:

1. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶

   ```bash
   # macOS
   ~/Library/Logs/AionUi/main.log

   # Windows
   %APPDATA%\AionUi\logs\main.log

   # Linux
   ~/.config/AionUi/logs/main.log
   ```

2. æ£€æŸ¥ç«¯å£å ç”¨ï¼ˆWebUI æ¨¡å¼ï¼‰

   ```bash
   # macOS/Linux
   lsof -i :3000

   # Windows
   netstat -ano | findstr :3000
   ```

3. æ¸…é™¤ç¼“å­˜

   ```bash
   # macOS
   rm -rf ~/Library/Application\ Support/AionUi

   # Windows
   rmdir /s %APPDATA%\AionUi

   # Linux
   rm -rf ~/.config/AionUi
   ```

#### é—®é¢˜ 2: AI å“åº”ç¼“æ…¢

**ç—‡çŠ¶**: æ¶ˆæ¯å‘é€åé•¿æ—¶é—´æ— å“åº”

**æ’æŸ¥æ­¥éª¤**:

1. æ£€æŸ¥ç½‘ç»œè¿æ¥

   ```bash
   ping generativelanguage.googleapis.com
   ```

2. æ£€æŸ¥ä»£ç†è®¾ç½®

   ```typescript
   // è®¾ç½® -> Gemini é…ç½® -> ä»£ç†
   proxy: 'http://proxy.example.com:8080';
   ```

3. æ£€æŸ¥ Worker è¿›ç¨‹

   ```bash
   # æŸ¥çœ‹è¿›ç¨‹
   ps aux | grep AionUi

   # æŸ¥çœ‹ CPU ä½¿ç”¨ç‡
   top -p $(pgrep AionUi)
   ```

#### é—®é¢˜ 3: æ–‡ä»¶é¢„è§ˆå¤±è´¥

**ç—‡çŠ¶**: ç‚¹å‡»æ–‡ä»¶åé¢„è§ˆé¢æ¿ç©ºç™½

**æ’æŸ¥æ­¥éª¤**:

1. æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ”¯æŒ
2. æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ>100MB å¯èƒ½å¤±è´¥ï¼‰
3. æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯
   ```typescript
   // æ‰“å¼€å¼€å‘è€…å·¥å…·
   ipcBridge.application.openDevTools();
   ```

### 12.2 è°ƒè¯•æŠ€å·§

#### å¯ç”¨è¯¦ç»†æ—¥å¿—

```typescript
// src/index.ts
if (process.env.DEBUG) {
  console.log = (...args) => {
    fs.appendFileSync('debug.log', args.join(' ') + '\n');
  };
}
```

#### ç›‘æ§ IPC é€šä¿¡

```typescript
// src/common/ipcBridge.ts
const originalBuildProvider = bridge.buildProvider;
bridge.buildProvider = (channel: string) => {
  const provider = originalBuildProvider(channel);
  return {
    ...provider,
    provider: (handler: any) => {
      return provider.provider(async (...args: any[]) => {
        console.log(`[IPC] ${channel}`, args);
        const result = await handler(...args);
        console.log(`[IPC] ${channel} result`, result);
        return result;
      });
    },
  };
};
```

#### æ€§èƒ½åˆ†æ

```typescript
// src/renderer/utils/performance.ts
export const measurePerformance = (name: string, fn: () => void) => {
  const start = performance.now();
  fn();
  const end = performance.now();
  console.log(`[Performance] ${name}: ${end - start}ms`);
};

// ä½¿ç”¨
measurePerformance('Render MessageList', () => {
  render(<MessageList messages={messages} />);
});
```

---

## 13. é™„å½•

### 13.1 æœ¯è¯­è¡¨

| æœ¯è¯­          | è¯´æ˜                                    |
| ------------- | --------------------------------------- |
| **IPC**       | Inter-Process Communicationï¼Œè¿›ç¨‹é—´é€šä¿¡ |
| **Bridge**    | ç±»å‹å®‰å…¨çš„ IPC å°è£…å±‚                   |
| **Agent**     | AI ä»£ç†ï¼Œè´Ÿè´£ä¸ LLM äº¤äº’                |
| **Worker**    | å·¥ä½œè¿›ç¨‹ï¼Œéš”ç¦»æ‰§è¡Œ AI ä»»åŠ¡              |
| **Manager**   | Agent ç®¡ç†å™¨ï¼Œè´Ÿè´£ç”Ÿå‘½å‘¨æœŸç®¡ç†          |
| **Skill**     | æŠ€èƒ½ï¼ŒåŸºäºæ–‡ä»¶çš„èƒ½åŠ›æ‰©å±•                |
| **Preset**    | é¢„è®¾ï¼Œé¢„é…ç½®çš„åŠ©æ‰‹æˆ–é…ç½®                |
| **MCP**       | Model Context Protocolï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®®  |
| **Pipe**      | è¿›ç¨‹é€šä¿¡ç®¡é“                            |
| **Workspace** | å·¥ä½œç©ºé—´ï¼ŒAI å¯è®¿é—®çš„æ–‡ä»¶ç›®å½•           |

### 13.2 å‚è€ƒèµ„æº

#### å®˜æ–¹æ–‡æ¡£

- [Electron æ–‡æ¡£](https://www.electronjs.org/docs)
- [React æ–‡æ¡£](https://react.dev)
- [TypeScript æ–‡æ¡£](https://www.typescriptlang.org/docs)

#### ç›¸å…³é¡¹ç›®

- [Gemini CLI](https://github.com/google/generative-ai-js)
- [Claude Code](https://claude.ai/code)
- [MCP Protocol](https://modelcontextprotocol.io)

#### ç¤¾åŒºèµ„æº

- [GitHub Issues](https://github.com/iOfficeAI/AionUi/issues)
- [Discord ç¤¾åŒº](https://discord.gg/g6u66vV9)
- [å®˜æ–¹ç½‘ç«™](https://www.aionui.com)

### 13.3 è´¡çŒ®æŒ‡å—

#### æäº¤ Issue

1. æœç´¢ç°æœ‰ Issueï¼Œé¿å…é‡å¤
2. ä½¿ç”¨ Issue æ¨¡æ¿
3. æä¾›è¯¦ç»†çš„å¤ç°æ­¥éª¤
4. é™„ä¸Šæ—¥å¿—å’Œæˆªå›¾

#### æäº¤ Pull Request

1. Fork ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
   ```bash
   git checkout -b feature/amazing-feature
   ```
3. æäº¤ä»£ç 
   ```bash
   git commit -m 'feat: add amazing feature'
   ```
4. æ¨é€åˆ°åˆ†æ”¯
   ```bash
   git push origin feature/amazing-feature
   ```
5. åˆ›å»º Pull Request

#### ä»£ç è§„èŒƒ

- éµå¾ª ESLint å’Œ Prettier é…ç½®
- ç¼–å†™å•å…ƒæµ‹è¯•
- æ›´æ–°æ–‡æ¡£
- ä½¿ç”¨è¯­ä¹‰åŒ–æäº¤ä¿¡æ¯

---

## 14. æ€»ç»“

AionUi æ˜¯ä¸€ä¸ªæ¶æ„æ¸…æ™°ã€è®¾è®¡ä¼˜é›…çš„ Electron åº”ç”¨ï¼Œé€šè¿‡ä»¥ä¸‹æ ¸å¿ƒè®¾è®¡å®ç°äº†å¼ºå¤§çš„åŠŸèƒ½ï¼š

### 14.1 æ ¸å¿ƒä¼˜åŠ¿

1. **å¤šè¿›ç¨‹éš”ç¦»æ¶æ„** - ç¡®ä¿ UI æµç•…æ€§å’Œä»»åŠ¡ç¨³å®šæ€§
2. **ç±»å‹å®‰å…¨çš„ IPC Bridge** - å‰åç«¯é€šä¿¡ç±»å‹å®‰å…¨
3. **æ’ä»¶åŒ–æŠ€èƒ½ç³»ç»Ÿ** - é€šè¿‡æ–‡ä»¶å®šä¹‰æ‰©å±•èƒ½åŠ›
4. **é¢„è®¾åŠ©æ‰‹ç³»ç»Ÿ** - é…ç½®åŒ–é©±åŠ¨åŠ©æ‰‹åˆ›å»º
5. **æ··åˆå­˜å‚¨æ–¹æ¡ˆ** - SQLite + JSON åŒé‡ä¿éšœ
6. **WebUI è¿œç¨‹è®¿é—®** - æ”¯æŒè·¨è®¾å¤‡ä½¿ç”¨
7. **MCP åè®®é›†æˆ** - æ ‡å‡†åŒ–å·¥å…·è®¿é—®

### 14.2 æŠ€æœ¯äº®ç‚¹

- **React 19** + **Arco Design** ç°ä»£åŒ– UI
- **Better-SQLite3** é«˜æ€§èƒ½åµŒå…¥å¼æ•°æ®åº“
- **Worker Process** éš”ç¦»æ‰§è¡Œé¿å…é˜»å¡
- **Virtual Scrolling** ä¼˜åŒ–é•¿åˆ—è¡¨æ€§èƒ½
- **Code Splitting** æŒ‰éœ€åŠ è½½å‡å°‘åŒ…ä½“ç§¯
- **File Watching** å®æ—¶ç›‘å¬æ–‡ä»¶å˜åŒ–
- **Stream Processing** æµå¼å¤„ç†å¤§æ–‡ä»¶

### 14.3 æœªæ¥å±•æœ›

- æ”¯æŒæ›´å¤š AI æ¨¡å‹ï¼ˆOpenAIã€Anthropicã€æœ¬åœ°æ¨¡å‹ï¼‰
- å¢å¼ºåä½œåŠŸèƒ½ï¼ˆå¤šç”¨æˆ·ã€æƒé™ç®¡ç†ï¼‰
- ç§»åŠ¨ç«¯é€‚é…ï¼ˆiOSã€Androidï¼‰
- æ’ä»¶å¸‚åœºï¼ˆç¤¾åŒºè´¡çŒ®æŠ€èƒ½å’ŒåŠ©æ‰‹ï¼‰
- äº‘åŒæ­¥ï¼ˆè·¨è®¾å¤‡æ•°æ®åŒæ­¥ï¼‰

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£å°†éšé¡¹ç›®æ›´æ–°æŒç»­ç»´æŠ¤ï¼Œæ¬¢è¿è´¡çŒ®æ”¹è¿›å»ºè®®ã€‚

**æœ€åæ›´æ–°**: 2026-01-27  
**æ–‡æ¡£ä½œè€…**: Kiro AI Assistant  
**é¡¹ç›®åœ°å€**: https://github.com/iOfficeAI/AionUi
